{% extends 'simple_layout.html' %}

{% block title %}Upload Data - Simple Crop Advisor{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <h1 class="display-5 fw-bold mb-3">Upload Crop Data</h1>
        <p class="lead mb-4">Enhance the recommendation system by uploading your own crop data</p>
    </div>
</section>

<!-- Upload Form Section -->
<section class="py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">Upload CSV File</div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="mb-4">
                                <label for="csv-file" class="form-label">CSV File</label>
                                <input type="file" class="form-control" id="csv-file" name="csv_file" accept=".csv">
                                <div class="form-text">The CSV file must contain the following columns: label, N, P, K, temperature, humidity, ph, rainfall</div>
                            </div>
                            
                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary">Upload and Process</button>
                            </div>
                            
                            <!-- Loading Spinner -->
                            <div id="upload-spinner" class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Processing your data...</p>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">CSV Format Information</div>
                    <div class="card-body">
                        <h5 class="mb-3">Required CSV Format</h5>
                        <p>Your CSV file must include the following columns:</p>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Column Name</th>
                                        <th>Description</th>
                                        <th>Data Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>label</td>
                                        <td>Name of the crop</td>
                                        <td>Text</td>
                                    </tr>
                                    <tr>
                                        <td>N</td>
                                        <td>Nitrogen content in soil (kg/ha)</td>
                                        <td>Number</td>
                                    </tr>
                                    <tr>
                                        <td>P</td>
                                        <td>Phosphorus content in soil (kg/ha)</td>
                                        <td>Number</td>
                                    </tr>
                                    <tr>
                                        <td>K</td>
                                        <td>Potassium content in soil (kg/ha)</td>
                                        <td>Number</td>
                                    </tr>
                                    <tr>
                                        <td>temperature</td>
                                        <td>Temperature (Â°C)</td>
                                        <td>Number</td>
                                    </tr>
                                    <tr>
                                        <td>humidity</td>
                                        <td>Humidity (%)</td>
                                        <td>Number</td>
                                    </tr>
                                    <tr>
                                        <td>ph</td>
                                        <td>pH value of soil</td>
                                        <td>Number</td>
                                    </tr>
                                    <tr>
                                        <td>rainfall</td>
                                        <td>Rainfall (mm)</td>
                                        <td>Number</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <h5 class="mb-3 mt-4">Example CSV Format</h5>
                        <pre class="bg-light p-3 rounded">
label,N,P,K,temperature,humidity,ph,rainfall
rice,80,40,40,23,80,6.5,200
maize,85,50,20,22,65,6.0,85
wheat,70,45,30,20,55,6.5,100</pre>
                        
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle me-2"></i> Adding your own data will enhance the recommendation system's accuracy for your specific growing conditions.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('upload-form');
    
    if (uploadForm) {
        uploadForm.addEventListener('submit', handleUpload);
    }
});

function handleUpload(event) {
    event.preventDefault();
    
    // Show loading spinner
    const uploadSpinner = document.getElementById('upload-spinner');
    uploadSpinner.style.display = 'block';
    
    // Get form data
    const formData = new FormData(event.target);
    
    // Send request to server
    fetch('/api/upload_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading spinner
        uploadSpinner.style.display = 'none';
        
        if (data.success) {
            displaySuccess(data.message, data.crop_count);
        } else {
            displayError(data.error);
        }
    })
    .catch(error => {
        // Hide loading spinner
        uploadSpinner.style.display = 'none';
        displayError('An error occurred while processing your request. Please try again later.');
        console.error('Error:', error);
    });
}

function displaySuccess(message, cropCount) {
    const successAlert = document.createElement('div');
    successAlert.className = 'alert alert-success alert-dismissible fade show';
    successAlert.setAttribute('role', 'alert');
    successAlert.innerHTML = `
        <strong>Success!</strong> ${message}. The system now has data for ${cropCount} crops.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const formContainer = document.querySelector('.card-body');
    formContainer.insertBefore(successAlert, document.getElementById('upload-form'));
    
    // Reset the form
    document.getElementById('upload-form').reset();
}

function displayError(message) {
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show';
    errorAlert.setAttribute('role', 'alert');
    errorAlert.innerHTML = `
        <strong>Error:</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const formContainer = document.querySelector('.card-body');
    formContainer.insertBefore(errorAlert, document.getElementById('upload-form'));
}
</script>
{% endblock %}
