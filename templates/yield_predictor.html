{% extends 'simple_layout.html' %}

{% block title %}Yield Predictor - Simple Crop Advisor{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <h1 class="display-5 fw-bold mb-3">Crop Yield Predictor</h1>
        <p class="lead mb-4">Predict potential yield based on soil parameters and environmental conditions</p>
    </div>
</section>

<!-- Yield Predictor Form Section -->
<section class="py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">Enter Crop and Parameters</div>
                    <div class="card-body">
                        <form id="yield-predictor-form">
                            <div class="mb-3">
                                <label for="crop-select" class="form-label">Select Crop</label>
                                <select class="form-select" id="crop-select" name="crop" required>
                                    <option value="" selected disabled>Select a crop</option>
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="nitrogen" class="form-label">Nitrogen (N) Content</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1" id="nitrogen" name="nitrogen" min="0" max="140" value="50">
                                        <span class="range-value ms-3" id="nitrogen-value">50</span>
                                        <span class="ms-1">kg/ha</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="phosphorus" class="form-label">Phosphorus (P) Content</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1" id="phosphorus" name="phosphorus" min="5" max="145" value="50">
                                        <span class="range-value ms-3" id="phosphorus-value">50</span>
                                        <span class="ms-1">kg/ha</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="potassium" class="form-label">Potassium (K) Content</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1" id="potassium" name="potassium" min="5" max="205" value="50">
                                        <span class="range-value ms-3" id="potassium-value">50</span>
                                        <span class="ms-1">kg/ha</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="temperature" class="form-label">Temperature</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1" id="temperature" name="temperature" min="0" max="50" value="25">
                                        <span class="range-value ms-3" id="temperature-value">25</span>
                                        <span class="ms-1">°C</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="humidity" class="form-label">Humidity</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1" id="humidity" name="humidity" min="0" max="100" value="65">
                                        <span class="range-value ms-3" id="humidity-value">65</span>
                                        <span class="ms-1">%</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="ph" class="form-label">pH Value</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1" id="ph" name="ph" min="0" max="14" step="0.1" value="6.5">
                                        <span class="range-value ms-3" id="ph-value">6.5</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="rainfall" class="form-label">Rainfall</label>
                                <div class="d-flex align-items-center">
                                    <input type="range" class="form-range flex-grow-1" id="rainfall" name="rainfall" min="0" max="300" value="150">
                                    <span class="range-value ms-3" id="rainfall-value">150</span>
                                    <span class="ms-1">mm</span>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Predict Yield Potential</button>
                            </div>
                            
                            <!-- Loading Spinner -->
                            <div id="loading-spinner" class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Calculating yield potential...</p>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div id="results-section" class="results-section">
                    <div class="card mb-4">
                        <div class="card-header">Yield Prediction Results</div>
                        <div class="card-body">
                            <div class="row mb-4 align-items-center">
                                <div class="col-md-6 text-center">
                                    <h5 class="mb-3">Yield Potential</h5>
                                    <div id="yield-gauge-container" style="position: relative; height: 200px; width: 200px; margin: 0 auto;">
                                        <canvas id="yield-gauge"></canvas>
                                        <div id="yield-score-display" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                            <div id="yield-percentage" style="font-size: 28px; font-weight: bold; color: var(--primary);">85%</div>
                                            <div style="font-size: 16px;">Potential</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="mb-3">Parameter Analysis</h5>
                                    <div id="parameter-scores-container">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5 class="mb-3">Limiting Factors</h5>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="limiting-factors-text">The following factors are limiting your potential yield:</span>
                                    <ul id="limiting-factors-list" class="mb-0 mt-2">
                                        <!-- Will be populated by JavaScript -->
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Optimal Conditions for <span id="crop-name-display">Rice</span></h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <ul id="optimal-conditions-list-1">
                                                <!-- Will be populated by JavaScript -->
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul id="optimal-conditions-list-2">
                                                <!-- Will be populated by JavaScript -->
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> This prediction is based on how closely your conditions match the optimal growing conditions for the selected crop. Actual yields depend on many additional factors including seed quality, pest management, and farming practices.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Improving Yields Section -->
<section class="py-4 bg-light">
    <div class="container">
        <h2 class="section-title text-center mb-4">Tips for Maximizing Crop Yields</h2>
        
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-flask" style="font-size: 2.5rem; color: var(--primary);"></i>
                        </div>
                        <h5 class="card-title text-center" style="color: var(--primary);">Soil Management</h5>
                        <ul class="mt-3">
                            <li>Conduct regular soil tests to monitor nutrient levels</li>
                            <li>Apply appropriate fertilizers based on soil test results</li>
                            <li>Maintain optimal soil pH for your specific crop</li>
                            <li>Implement crop rotation to improve soil health</li>
                            <li>Use cover crops to reduce erosion and add organic matter</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-tint" style="font-size: 2.5rem; color: var(--primary);"></i>
                        </div>
                        <h5 class="card-title text-center" style="color: var(--primary);">Water Management</h5>
                        <ul class="mt-3">
                            <li>Implement efficient irrigation systems</li>
                            <li>Schedule irrigation based on crop water requirements</li>
                            <li>Utilize rainwater harvesting when possible</li>
                            <li>Apply mulching to reduce evaporation</li>
                            <li>Monitor soil moisture levels regularly</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-bug" style="font-size: 2.5rem; color: var(--primary);"></i>
                        </div>
                        <h5 class="card-title text-center" style="color: var(--primary);">Pest & Disease Management</h5>
                        <ul class="mt-3">
                            <li>Implement integrated pest management (IPM)</li>
                            <li>Scout regularly for early detection of issues</li>
                            <li>Introduce beneficial insects when appropriate</li>
                            <li>Select disease-resistant crop varieties</li>
                            <li>Maintain proper plant spacing for airflow</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update range input values
    const rangeInputs = document.querySelectorAll('input[type="range"]');
    rangeInputs.forEach(input => {
        const valueDisplay = document.getElementById(`${input.id}-value`);
        if (valueDisplay) {
            // Set initial value
            valueDisplay.textContent = input.value;
            
            // Update on input change
            input.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });
        }
    });
    
    // Load crop options
    loadCropOptions();
    
    // Handle form submission
    const yieldPredictorForm = document.getElementById('yield-predictor-form');
    if (yieldPredictorForm) {
        yieldPredictorForm.addEventListener('submit', handleYieldPredictorFormSubmit);
    }
});

// Load crop options for the select element
function loadCropOptions() {
    const cropSelect = document.getElementById('crop-select');
    if (cropSelect) {
        fetch('/api/crops')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Sort crops alphabetically
                    const crops = data.crops.sort();
                    
                    // Add options to select element
                    crops.forEach(crop => {
                        const option = document.createElement('option');
                        option.value = crop;
                        option.textContent = capitalizeFirstLetter(crop);
                        cropSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading crops:', error);
            });
    }
}

function handleYieldPredictorFormSubmit(event) {
    event.preventDefault();
    
    // Show loading spinner
    const loadingSpinner = document.getElementById('loading-spinner');
    loadingSpinner.style.display = 'block';
    
    // Hide previous results
    document.getElementById('results-section').style.display = 'none';
    
    // Get form data
    const formData = new FormData(event.target);
    
    // Send request to server
    fetch('/api/predict_yield', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading spinner
        loadingSpinner.style.display = 'none';
        
        if (data.success) {
            displayYieldResults(data, formData);
        } else {
            displayError(data.error);
        }
    })
    .catch(error => {
        // Hide loading spinner
        loadingSpinner.style.display = 'none';
        displayError('An error occurred while processing your request. Please try again later.');
        console.error('Error:', error);
    });
}

function displayYieldResults(data, formData) {
    // Update crop name
    const cropName = formData.get('crop');
    document.getElementById('crop-name-display').textContent = capitalizeFirstLetter(cropName);
    
    // Update yield percentage
    const yieldPercentage = Math.round(data.yield_potential);
    document.getElementById('yield-percentage').textContent = `${yieldPercentage}%`;
    
    // Create gauge chart
    createYieldGaugeChart(yieldPercentage);
    
    // Update parameter scores
    const parameterScoresContainer = document.getElementById('parameter-scores-container');
    parameterScoresContainer.innerHTML = '';
    
    const parameters = [
        { name: 'Nitrogen', score: data.parameter_scores.Nitrogen },
        { name: 'Phosphorus', score: data.parameter_scores.Phosphorus },
        { name: 'Potassium', score: data.parameter_scores.Potassium },
        { name: 'Temperature', score: data.parameter_scores.Temperature },
        { name: 'Humidity', score: data.parameter_scores.Humidity },
        { name: 'pH', score: data.parameter_scores.pH },
        { name: 'Rainfall', score: data.parameter_scores.Rainfall }
    ];
    
    parameters.forEach(param => {
        const scorePercentage = Math.round(param.score * 100);
        let colorClass = 'bg-danger';
        
        if (scorePercentage >= 75) {
            colorClass = 'bg-success';
        } else if (scorePercentage >= 50) {
            colorClass = 'bg-warning';
        }
        
        const paramElement = document.createElement('div');
        paramElement.className = 'mb-2';
        paramElement.innerHTML = `
            <div class="d-flex justify-content-between mb-1">
                <span>${param.name}</span>
                <span>${scorePercentage}%</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar ${colorClass}" role="progressbar" style="width: ${scorePercentage}%" aria-valuenow="${scorePercentage}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        `;
        
        parameterScoresContainer.appendChild(paramElement);
    });
    
    // Update limiting factors
    const limitingFactorsList = document.getElementById('limiting-factors-list');
    limitingFactorsList.innerHTML = '';
    
    if (data.limiting_factors.length > 0) {
        data.limiting_factors.forEach(factor => {
            const li = document.createElement('li');
            const scorePercentage = Math.round(factor[1] * 100);
            li.innerHTML = `<strong>${factor[0]}:</strong> ${scorePercentage}% optimal`;
            limitingFactorsList.appendChild(li);
        });
    } else {
        document.getElementById('limiting-factors-text').textContent = 'All parameters are within optimal ranges.';
    }
    
    // Get optimal conditions for the crop
    fetch(`/api/crop_conditions?crop=${cropName}`)
        .then(response => response.json())
        .then(conditionsData => {
            if (conditionsData.success) {
                const conditions = conditionsData.conditions;
                
                // Update optimal conditions lists
                const list1 = document.getElementById('optimal-conditions-list-1');
                const list2 = document.getElementById('optimal-conditions-list-2');
                
                list1.innerHTML = '';
                list2.innerHTML = '';
                
                const optimalConditions = [
                    { name: 'Nitrogen', min: conditions.n_min.toFixed(1), max: conditions.n_max.toFixed(1), unit: 'kg/ha' },
                    { name: 'Phosphorus', min: conditions.p_min.toFixed(1), max: conditions.p_max.toFixed(1), unit: 'kg/ha' },
                    { name: 'Potassium', min: conditions.k_min.toFixed(1), max: conditions.k_max.toFixed(1), unit: 'kg/ha' },
                    { name: 'Temperature', min: conditions.temperature_min.toFixed(1), max: conditions.temperature_max.toFixed(1), unit: '°C' },
                    { name: 'Humidity', min: conditions.humidity_min.toFixed(1), max: conditions.humidity_max.toFixed(1), unit: '%' },
                    { name: 'pH', min: conditions.ph_min.toFixed(1), max: conditions.ph_max.toFixed(1), unit: '' },
                    { name: 'Rainfall', min: conditions.rainfall_min.toFixed(1), max: conditions.rainfall_max.toFixed(1), unit: 'mm' }
                ];
                
                // Split conditions between the two lists
                const midpoint = Math.ceil(optimalConditions.length / 2);
                
                optimalConditions.slice(0, midpoint).forEach(condition => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${condition.name}:</strong> ${condition.min} - ${condition.max} ${condition.unit}`;
                    list1.appendChild(li);
                });
                
                optimalConditions.slice(midpoint).forEach(condition => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${condition.name}:</strong> ${condition.min} - ${condition.max} ${condition.unit}`;
                    list2.appendChild(li);
                });
            }
        })
        .catch(error => {
            console.error('Error getting crop conditions:', error);
        });
    
    // Display results section
    document.getElementById('results-section').style.display = 'block';
    
    // Scroll to results
    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
}

function createYieldGaugeChart(yieldPercentage) {
    const ctx = document.getElementById('yield-gauge').getContext('2d');
    
    // Determine color based on yield percentage
    let color = '#D32F2F'; // Red for poor
    
    if (yieldPercentage >= 75) {
        color = '#388E3C'; // Green for good
    } else if (yieldPercentage >= 50) {
        color = '#FFA000'; // Amber for moderate
    }
    
    // Destroy previous chart if exists
    if (window.yieldChart) {
        window.yieldChart.destroy();
    }
    
    // Create gauge chart
    window.yieldChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [yieldPercentage, 100 - yieldPercentage],
                backgroundColor: [color, '#E0E0E0'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '75%',
            rotation: -90,
            circumference: 180,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            }
        }
    });
}

function displayError(message) {
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger alert-dismissible fade show';
    errorAlert.setAttribute('role', 'alert');
    errorAlert.innerHTML = `
        <strong>Error:</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const formContainer = document.querySelector('.card-body');
    formContainer.insertBefore(errorAlert, document.getElementById('yield-predictor-form'));
}

// Helper function to capitalize the first letter of each word
function capitalizeFirstLetter(string) {
    return string.split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}
</script>
{% endblock %}
